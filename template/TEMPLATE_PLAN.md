# {機能名} 実装計画書

**実行AIモデル名**: {実行モデル名 例: claude-4-sonnet, claude-4-opus}  
**作成日**: {YYYY-MM-DD}  

## 1. 目的と背景

{このタスクの目的、背景、概要を簡潔に記述。  
例:  
本タスクは、既存の注文システムに「固定金額割引機能」を追加することを目的とする。  
従来は注文金額に対してパーセント割引のみが適用可能だが、本機能追加により、管理者が発行したクーポンコードを注文時に入力することで、定額（例：500円引き）による割引も適用できるようになる。  

背景:  
- 顧客の購買促進やリピーター獲得のため、パーセント割引に加え、より多様な割引施策（定額割引）が求められていた。  
- 管理者がキャンペーンやプロモーションに応じて固定金額割引クーポンを発行・管理できる仕組みが必要だった。  

概要:  
- 固定金額割引クーポンの新規発行・編集・無効化機能を管理画面に追加  
- 注文時にクーポンコードを入力できるUIを追加  
- クーポンの有効性判定、固定金額割引適用ロジックの実装  
- 割引適用後の金額計算・表示（パーセント割引・定額割引の両対応）  
- クーポン利用履歴の記録  
}

## 2. 対象領域

### 2.1 対象ドメイン

{対象ドメインをリストアップし、各ドメインの役割と変更点を記述。アーキテクチャのfeatures/配下を基準に。  
例:  
- Coupon: 定額割引機能追加のため  
  - src/features/coupon/core/coupon.ts: 定額割引タイプのエンティティ追加  
  - src/features/coupon/policy/coupon_policy.ts: 定額割引可否判定ロジック追加  
  - src/features/coupon/port/coupon_port.ts: 割引タイプ関連のメソッド追加  
- Order: 割引反映のため  
  - src/features/order/core/order.ts: 割引計算ロジックの拡張  
}

### 2.2 対象フロー

{対象フローをリストアップし、各フローの役割と変更点を記述。アーキテクチャのflows/配下を基準に。  
例:  
- OrderProcess (src/flows/order_process/handler.ts): 割引反映のため。クーポン適用ステップを追加し、複数ドメインのcommand/queryを調整。  
}

### 2.3 対象Adapter

{対象Adapterをリストアップし、各Adapterの役割と変更点を記述。アーキテクチャのadapter/配下を基準に。  
例:  
- CouponRepository (src/adapter/repository/couponRepository.prisma.ts): クーポンデータの永続化。定額割引関連カラムの保存/取得を追加。  
- PaymentService (src/adapter/service/payment.service.ts): 割引適用後の決済処理。外部API呼び出しを調整。  
}

### 2.4 対象ページ

{対象ページをリストアップし、各ページの役割と変更点を記述。アーキテクチャのpages/配下を基準に。  
例:  
- CouponPage (src/pages/coupon/+page.svelte): クーポン管理画面。  
}

## 3. 機能要件

### 3.1 機能の概要

{機能の全体像を簡潔に記述。期待される動作をまとめる。アーキテクチャ原則（依存方向、副作用ゼロなど）を考慮。  

例:  
クーポン機能に新たに定額割引タイプを追加する機能です。従来の割合割引（例：10%オフ）に加えて、定額割引（例：500円オフ）を設定・適用できるようになります。  

**主な機能**:  
- 定額割引タイプのクーポン作成・編集  
- 注文時の定額割引自動適用  
- 割引後金額の計算・表示  
- 定額割引特有の制約（最低購入金額など）の考慮  

**期待される効果**:  
- より柔軟なプロモーション戦略の実現  
- 顧客の購買促進効果向上  
- 管理者の運用負荷軽減  
}

### 3.2 詳細要件

{実装内容を詳細に記述。ユースケース、フロー、条件分岐などを箇条書きや図で説明。アーキテクチャのレイヤ（core/policy/port/command/query/flows）を基に構造化。  
例:  
- **core/レベル**: 純粋関数で割引計算を実装（例: calculateDiscountAmount関数）。不変条件をFactoryで保証。  
- **policy/レベル**: 複数エンティティにわたる規則（例: canApplyFixedDiscount関数）。  
- **command/query/レベル**:  
  - 入力: クーポンコード、注文データ  
  - 処理: core.tsで検証、handler.tsでadapter経由の副作用実行  
  - 出力: 割引適用後注文データ  
- **flows/レベル**: 注文処理全体のオーケストレーション（command/queryの順序制御）。  
- 条件分岐: クーポン有効期限切れ時はエラー、適用可能時は金額減算。  
- シーケンス図（テキストベース）:  
  interfaces/api → flows/handler → command/handler → adapter/repository  
}

### 3.3 非機能要件

{アーキテクチャのガイドライン（行数制限、依存監視）を考慮。  
例:  
- 入力検証: 入力値の検証を行う
}

### 3.4 実装対象ファイル

{対象ファイルをリストアップし、各ファイルの役割と変更点を記述。アーキテクチャのディレクトリ構成に準拠。  
例:  
- src/lib/server/features/coupon/core/coupon.ts: 定額割引エンティティ追加  
- src/lib/server/features/coupon/command/create-coupon/handler.ts: 定額割引作成ハンドラ  
- src/lib/server/flows/order_process/handler.ts: 割引適用フロー調整  
- src/lib/server/adapter/repository/couponRepository.prisma.ts: Prisma操作拡張  
- src/lib/server/interfaces/api.ts: エンドポイント定義追加  
}

### 3.5 テストケース

{ユニットテスト、統合テスト、エンドツーエンドテストのケースを列挙。アーキテクチャのテスト戦略（core:モック不要、adapter:契約テストなど）に準拠。入力/期待出力/エッジケースを含む。  
例:  
- **core/ユニット**: テストケース1: 定額割引計算（入力: 1000円注文, 500円割引 → 期待: 500円）。エッジ: 割引額超過時エラー。  
- **command/query/ユニット**: テストケース2: クーポン適用（ポートをダミー注入）。  
- **flows/統合**: テストケース3: 全体フロー（実際のcommand/query結合）。  
- **adapter/契約**: テストケース4: DBモックでクーポン保存確認。  
- エッジケース: 無効クーポン、無効期限、同時適用制限。  
}

## 4. 実装方法

### 4.1 全体アプローチ

{AIエージェントを使った実装ステップを記述。アーキテクチャの手順（ドメインリスト→設計→core/port→adapterなど）を基に。  
例: 「仕様書をプロンプトとしてAIに渡し、コード生成 → レビュー → 修正サイクル。依存方向を厳守し、portから実装開始。」  
}

### 4.2 依存関係

{必要なライブラリ、API、他の機能との依存をリスト。アーキテクチャの原則（DI不使用、直接実装使用）を考慮。  
例:  
- 依存ライブラリ: Prisma, Zod (入力検証用)  
- 依存機能: 既存のOrderドメイン  
- 外部API: PaymentGateway (adapter経由)  
}

### 4.3 コード生成ガイドライン

{AIに渡すための具体的な指示。アーキテクチャのコーディングガイドライン（Readonly型、不変条件、副作用禁止など）を明記。  
例: 「TypeScriptを使用。ESLint準拠。core/は純粋関数のみ。コメントを詳細に追加。handler.tsで直接インスタンス使用。」  
}

## 5. 懸念点と潜在リスク

{実装の懸念点、AI生成の不足可能性を箇条書きで具体的に指摘。アーキテクチャの原則違反（依存方向崩れ、副作用混入）やAI限界を考慮。  
例:  
- 依存方向違反のリスク（featuresからadapter直import）。eslintで監視。  
- AI生成コードの副作用混入（core/に日時取得が入る可能性）。  
- エッジケース無視（例: クーポン同時適用制限）。手動レビュー必須。  
- 行数超過による複雑化。抽出を推奨。  
}

## 6. 確認事項と検証結果

{AI生成後の検証テーブル。Passed/Failedで結果を記録し、残課題を記述。アーキテクチャのテスト戦略/CIルールを基にカテゴリ拡張。}

| 項目カテゴリ     | 結果 (Passed/Failed) | コメント・残課題 |
|------------------|----------------------|------------------|
| テストカバレッジ| {Passed/Failed}     | {例: 80%達成。追加テストケース提案行数監視OK} |
| アーキテクチャ遵守 | {Passed/Failed}  | {例: 依存方向違反なし。行数監視OK} |
| ドキュメント    | {Passed/Failed}     | {例: コードコメント不足行数監視OK} |
